<?php

use Drupal\Core\Routing\RouteMatchInterface;

include('ParselyMetadata.php');
include('section.inc');

/**
 * Implements hook_page_bottom().
 */
function parsely_page_bottom(array &$page_bottom)
{
    // TODO: if we're not supposed to track, get outta here
    $apikey = \Drupal::config('parsely.settings')->get('parsely_apikey');
    $markup = <<<EOT

<!-- START Parse.ly Include: Standard -->
<div id="parsely-root" style="display: none">
  <div id="parsely-cfg" data-parsely-site="$apikey"></div>
</div>
<script>
(function(s, p, d) {
  var h=d.location.protocol, i=p+"-"+s,
    e=d.getElementById(i), r=d.getElementById(p+"-root"),
    u=h==="https:"?"d1z2jf7jlzjs58.cloudfront.net"
    :"static."+p+".com";
  if (e) return;
  e = d.createElement(s); e.id = i; e.async = true;
  e.src = h+"//"+u+"/p.js"; r.appendChild(e);
})("script", "parsely", document);
</script>
<!-- END Parse.ly Include: Standard -->


EOT;
}

/**
 * Implements hook_page_attachments().
 */
/**
 * Implements hook_page_top().
 */
//function parsely_page_top(array &$page_top)
//{
//    $node = \Drupal::routeMatch()->getParameter('node');
//    if ($node) {
//        $parsely_metadata = new ParselyMetadata($node);
//        $parsely_metas = [
//            '@context' => 'schema.org',
//            '@type' => 'NewsArticle',
//            'author' => $parsely_metadata->getCreator(),
//            'url' => $parsely_metadata->getURL($node),
//            'section' => $parsely_metadata->getSection(),
//            'keywords' => $parsely_metadata->getTags(),
//            'datePublished' => $parsely_metadata->getDate(),
//        ];
//        $parsely_tag = [
//            '#tag' => 'script',
//            '#attributes' => [
//                'type' => 'application/ld+json'
//            ],
//            '#value' => json_encode('floog')
//        ];
//        $page_top['parsely'] = array('#attached' => $parsely_tag);
//}
//
//}

